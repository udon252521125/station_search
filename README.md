# 駅名縦クロスワード検索ツール

日本全国の駅データを使用して、縦クロスワードパズル用の駅名組み合わせを検索する高性能Streamlitアプリケーションです。

## 概要

このツールは、入力された文字列の各文字が「駅名内で同じ位置（インデックス）」に現れる駅の組み合わせを検索します。例えば「あいう」と入力すると、同じ文字位置（例：2文字目）に「あ」「い」「う」がそれぞれある駅を見つけ出し、縦クロスワードパズルの作成に役立てることができます。

## 主な特徴

### ⚡ **高速検索システム**
- **事前計算インデックス**: 位置×文字の組み合わせを事前計算してJSONファイルに保存
- **O(1)検索**: サブミリ秒（0.001-0.003ms）での超高速検索を実現
- **自動最適化**: インデックスが存在する場合は自動的に高速モードで動作

### 🔍 **検索機能**
- **文字位置一致検索**: 検索文字列の各文字が駅名内で同じ位置に現れる駅を検索
- **文字種正規化**: jaconvライブラリによる正確なひらがな/カタカナ変換
- **カタカナ処理切り替え**: カタカナを別文字として扱うか、ひらがなに変換するかを選択可能
- **地方・都道府県絞り込み**: 特定の地方や都道府県に検索範囲を限定可能
- **入力の都度自動再検索**: 文字入力や設定変更時に自動的に検索を実行

### 📊 **結果表示**
- **位置別グループ化**: 文字位置ごとに結果を整理して表示
- **完全な駅情報**: 駅名、都道府県、事業者、路線名を含む包括的な情報
- **視覚的区別**: 選択地域内と全国の駅を色分けで区別
- **対応文字表示**: 実際の駅名に含まれる文字（ひらがな/カタカナ/漢字）を表示

### 💾 **データ出力**
- **CSVダウンロード**: 検索結果をCSV形式でエクスポート
- **カスタムデータ対応**: 独自のCSVファイルをアップロードして使用可能

## データソース

- **駅データ**: [駅データ.jp（ekidata.jp）](https://ekidata.jp/) のオープンデータを使用
- **収録件数**: 約10,939件の駅データ（2025年6月時点）
- **路線情報**: 608路線、171事業者の完全なマッピング
- **含まれる情報**: 駅名、都道府県、路線名、事業者名、座標、営業状況等

## 必要なファイル

```
station_search/
├── station_search_gui.py      # メインアプリケーション
├── create_index.py            # 高速インデックス作成スクリプト
├── master_data.py             # 地方・都道府県マッピングデータ
├── requirements.txt           # 依存関係定義
├── station20250604free.csv    # 駅データ（メイン）
├── eki.csv                    # 路線・事業者データ
├── station_hiragana_index.json # 高速検索用インデックス（自動生成）
├── station_katakana_index.json # 高速検索用インデックス（自動生成）
├── station_data_indexed.csv   # インデックス化駅データ（自動生成）
└── README.md                  # このファイル
```

## インストール・セットアップ

### 動作環境・依存関係

**システム要件**
- **オペレーティングシステム**: Windows 10/11, macOS, Linux（Streamlit対応OS）
- **Python**: 3.9以上（動作確認済み）
- **メモリ**: 最低1GB（推奨2GB以上）

**必要なPythonライブラリ**
- **streamlit**: Webアプリケーションフレームワーク（1.0.0以上）
- **pandas**: データ処理・分析ライブラリ（1.3.0以上）
- **jaconv**: 日本語文字変換ライブラリ（ひらがな⇔カタカナ⇔ローマ字変換）

### 1. 必要なライブラリのインストール

```bash
# requirements.txtを使用した一括インストール（推奨）
pip install -r requirements.txt

# または個別にインストール
pip install streamlit>=1.0.0 pandas>=1.3.0 jaconv
```

### 2. データファイルの準備

以下のファイルが同一ディレクトリに必要です：
- `station20250604free.csv` - 駅データ
- `eki.csv` - 路線・事業者データ
- `master_data.py` - 地方区分マッピング

### 3. 高速インデックスの作成（推奨）

検索速度を大幅に向上させるため、事前にインデックスを作成できます：

```bash
python create_index.py
```

これにより以下のファイルが生成されます：
- `station_hiragana_index.json` - ひらがな/漢字検索用インデックス（24位置、3,870エントリ）
- `station_katakana_index.json` - カタカナ検索用インデックス（24位置、4,001エントリ）
- `station_data_indexed.csv` - 路線・事業者情報統合済み駅データ

**パフォーマンス向上効果**：
- 検索時間: 1-3秒 → 0.001-0.003ms（約1000倍高速化）
- メモリ使用量: 約50MB（効率的なインデックス構造）

### 4. アプリケーションの起動

```bash
streamlit run station_search_gui.py
```

ブラウザが自動で開き、`http://localhost:8501` でアプリケーションにアクセスできます。

インデックスファイルが存在する場合、自動的に高速検索モードで動作します。

## 使用方法

### 基本的な検索

1. **検索文字列入力**: ひらがな、漢字で検索したい文字列を入力（最大20文字）
2. **カタカナ処理設定**: 
   - オフ（デフォルト）: カタカナをひらがなに変換して検索
   - オン: カタカナを別文字として扱う
3. **地域選択**（オプション）: 特定の地方や都道府県を選択して検索範囲を限定
4. **結果確認**: 位置別に整理された検索結果を確認

### 検索例

**例1: 「しの」で検索**
```
検索文字列: しの
結果: 同じ位置（例：2文字目）に「し」と「の」がある駅の組み合わせ
- 2文字目での組み合わせ
  - 上野（の） - 2文字目が「の」
  - 品川（な） - 2文字目が「な」（該当なし）
  - 旭川（し） - 2文字目が「し」
```

**例2: 地域限定検索**
```
検索文字列: あいう
地域選択: 関東地方
結果: 関東地方内で同じ位置に「あ」「い」「う」がある駅の組み合わせ
```

## 注意事項

⚠️ **重要な注意事項**
- 検索結果通りに駅名が印字されるとは限りません
- 鉄道会社によって印字の方法が異なる場合があります
- 検索結果の文字表示は駅名データの元の文字種（ひらがな/カタカナ/漢字）に依存します
- 設定に関わらず、実際の表示文字が期待と異なる場合があります

## 技術仕様

### 開発環境
- **Python**: 3.9以上（動作確認済み）
- **フレームワーク**: Streamlit
- **主要ライブラリ**: pandas, jaconv

### アーキテクチャ
- **検索アルゴリズム**: 文字位置別インデックス検索
- **データ処理**: pandas DataFrame操作
- **文字正規化**: jaconv（ひらがな・カタカナ変換）
- **UI**: Streamlit Webアプリケーション

### パフォーマンス
- **データ件数**: 約10,939件（station20250604free.csv）
- **高速検索**: 0.001-0.003ms（インデックス使用時）
- **通常検索**: 1-3秒（インデックス未使用時）
- **メモリ使用量**: 約50-100MB
- **路線情報**: 608路線、171事業者（完全統合済み）

## ファイル構成詳細

### データファイル仕様

**station20250604free.csv（必須）**
- **データ件数**: 10,939件（2025年6月4日版）
- **必須項目**: 
  - station_name: 駅名（検索・表示に使用）
  - pref_cd: 都道府県コード（地域フィルタリングに使用）
  - line_cd: 路線コード（事業者・路線情報の統合に使用）
- **オプション項目**: 
  - 駅座標、営業状況、その他の駅情報（表示のみに使用）

**eki.csv（必須）**
- **用途**: 路線・事業者の詳細情報統合
- **データ件数**: 622件の路線・事業者マッピング
- **内容**: 路線コード、路線名、事業者名
- **統合結果**: 608路線、171事業者の完全マッピング

**master_data.py（必須）**
- **用途**: 地方区分と都道府県コードのマッピング定義
- **内容**: 8地方区分の都道府県コード配列

### `station_search_gui.py`
メインアプリケーションファイル。以下の機能を含む：
- Streamlit UI定義
- 高速インデックス検索ロジック実装
- 従来検索との自動切り替え
- データ処理・結果表示
- CSVダウンロード機能

### `create_index.py`（新規追加）
高速検索用インデックスの作成スクリプト：
- 位置×文字の組み合わせインデックスの事前計算
- eki.csvからの路線・事業者情報統合
- JSON形式での高速検索用ファイル生成
- パフォーマンステスト機能付き

### `master_data.py`
地方区分と都道府県コードのマッピングデータ：
```python
REGION_MAPPING = {
    '北海道地方': [1],
    '東北地方': [2, 3, 4, 5, 6, 7],
    '関東地方': [8, 9, 10, 11, 12, 13, 14],
    # ...
}
```

### データファイル
- **station20250604free.csv**: 駅マスターデータ（駅名、都道府県コード、路線コードなど）
- **eki.csv**: 路線・事業者マスターデータ（路線コード、路線名、事業者名など）

## カスタマイズ

### 独自データの使用
1. CSVファイルアップロード機能を使用
2. **必要な列**: `station_name`, `pref_cd`, `line_cd`
3. `eki.csv`と組み合わせて路線・事業者情報を自動統合
4. インデックス未作成の場合は通常検索モードで動作

### 検索アルゴリズムのカスタマイズ
- `normalize_search_string()`: 文字正規化ロジック（jaconv使用）
- `search_and_analyze_fast()`: 高速インデックス検索アルゴリズム
- `find_stations_by_index()`: インデックスベース駅検索
- 最大文字数制限: 現在20文字（変更可能）

### インデックス作成の調整
- `create_index.py`: インデックス生成パラメータの調整
- 文字位置範囲: 現在24文字まで対応
- メモリ使用量とファイルサイズのバランス調整

## トラブルシューティング

### よくある問題

**Q: アプリケーションが起動しない**
```bash
# ライブラリの再インストール
pip install --upgrade streamlit pandas jaconv

# ポート競合の場合
streamlit run station_search_gui.py --server.port 8502
```

**Q: データファイルが見つからない**
- `station20250604free.csv`と`eki.csv`が同一ディレクトリに配置されていることを確認
- ファイル名の大文字小文字を確認

**Q: 検索が遅い**
```bash
# 高速インデックスを作成
python create_index.py

# 作成後、アプリケーションを再起動
streamlit run station_search_gui.py
```

**Q: 路線・事業者情報が「不明」と表示される**
- `eki.csv`ファイルが同一ディレクトリに配置されていることを確認
- インデックスを再作成: `python create_index.py`
- アプリケーション右上メニューで「Clear cache」を実行

**Q: メモリ不足エラー**
- データサイズが大きい場合は、地域限定検索を使用
- 不要なアプリケーションを終了してメモリを確保

## ライセンス

このソフトウェアは自由にご利用いただけます。データソース（駅データ.jp）の利用規約に従ってご使用ください。

## 貢献・改善提案

バグ報告や機能改善の提案を歓迎します。

## 更新履歴

- **v2.0** (2025年7月): 高速化・機能拡張アップデート
  - 🚀 高速インデックス検索システム実装（約1000倍高速化）
  - 📊 路線・事業者情報の完全統合（608路線、171事業者）
  - 🔧 文字種混在問題の修正（jaconv正規化強化）
  - 📝 技術文書の精度向上
  - 💾 requirements.txt追加（依存関係の明確化）

- **v1.0** (2025年7月): 初回リリース
  - 基本的なクロスワード検索機能
  - 地方・都道府県絞り込み機能
  - カタカナ処理切り替え機能
  - CSVダウンロード機能

---

**データ提供**: [駅データ.jp](https://ekidata.jp/)  
**最終更新**: 2025年7月